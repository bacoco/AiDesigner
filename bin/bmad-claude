#!/usr/bin/env node

/**
 * BMAD Invisible Orchestrator - Chat Interface
 * Launches Claude CLI with MCP server and orchestrator agent
 */

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');
const { runIntegrityPreflight } = require('../common/utils/integrity');
const { ensureCliBinary } = require('../common/utils/cli-provisioning');

const getAssistantProvider = () =>
  (process.env.BMAD_ASSISTANT_PROVIDER || '').trim().toLowerCase();

const buildClaudeSpawnEnv = () => {
  const provider = getAssistantProvider();
  if (provider !== 'glm') {
    return { env: process.env, isGlm: false };
  }

  const preferEnvValue = (...keys) => {
    for (const key of keys) {
      const value = process.env[key];
      if (typeof value === 'string' && value.length > 0) {
        return value;
      }
    }
    return undefined;
  };

  const env = { ...process.env };
  const baseUrl = preferEnvValue('BMAD_GLM_BASE_URL', 'GLM_BASE_URL', 'ANTHROPIC_BASE_URL');
  const authToken = preferEnvValue('BMAD_GLM_AUTH_TOKEN', 'GLM_AUTH_TOKEN', 'ANTHROPIC_AUTH_TOKEN');
  const apiKey = preferEnvValue('BMAD_GLM_API_KEY', 'GLM_API_KEY', 'ANTHROPIC_API_KEY');

  if (baseUrl !== undefined) {
    env.ANTHROPIC_BASE_URL = baseUrl;
  } else {
    delete env.ANTHROPIC_BASE_URL;
  }

  if (authToken !== undefined) {
    env.ANTHROPIC_AUTH_TOKEN = authToken;
  } else {
    delete env.ANTHROPIC_AUTH_TOKEN;
  }

  if (apiKey !== undefined) {
    env.ANTHROPIC_API_KEY = apiKey;
  } else {
    delete env.ANTHROPIC_API_KEY;
  }

  env.LLM_PROVIDER = 'glm';

  return { env, isGlm: true };
};

// Get paths
const rootDir = path.join(__dirname, '..');
runIntegrityPreflight(rootDir, { silentOnMatch: true });
const mcpConfigPath = path.join(rootDir, 'mcp', 'bmad-config.json');
const orchestratorPath = path.join(rootDir, 'agents', 'invisible-orchestrator.md');

// Check if files exist
if (!fs.existsSync(mcpConfigPath)) {
  console.error('Error: MCP config not found. Run: npm run build:mcp');
  process.exit(1);
}

if (!fs.existsSync(orchestratorPath)) {
  console.error('Error: Orchestrator agent not found');
  process.exit(1);
}

// Read orchestrator content and strip YAML frontmatter
let orchestratorContent = fs.readFileSync(orchestratorPath, 'utf8');

// Remove YAML frontmatter (everything between --- markers)
orchestratorContent = orchestratorContent.replace(/^---\n[\s\S]*?\n---\n/, '');

async function main() {
  const claudeCheck = await ensureCliBinary({
    rootDir,
    binaryName: 'claude',
    friendlyName: 'Claude Code CLI',
    installGuide: {
      autoInstallCommand:
        'npm exec --yes @anthropic-ai/claude-code@latest -- claude --help',
      manualSteps: [
        {
          label: 'Homebrew (macOS/Linux)',
          command: 'brew install anthropic-ai/anthropic/claude',
        },
        {
          label: 'Official installer & docs',
          url: 'https://claude.ai/code',
        },
      ],
    },
  });

  if (!claudeCheck.ok) {
    process.exit(claudeCheck.exitCode ?? 1);
  }

  // Build Claude command
  const claudeArgs = [
    '--mcp-config', mcpConfigPath,
    '--append-system-prompt', orchestratorContent,
  ];

  // Add any additional args from user
  const userArgs = process.argv.slice(2);
  if (userArgs.length > 0) {
    claudeArgs.push(...userArgs);
  }

  console.log('ðŸŽ¯ Starting BMAD Invisible Orchestrator...');
  console.log('ðŸ“¡ MCP Server: bmad-invisible-orchestrator');
  console.log('ðŸ¤– Agent: Invisible BMAD Orchestrator');
  console.log('ðŸ’¬ Type your project idea to begin!\n');

  const claudeBinary = claudeCheck.binaryPath || 'claude';
  const { env: claudeEnv, isGlm } = buildClaudeSpawnEnv();

  if (isGlm) {
    console.log('ðŸŒ GLM mode active: routing Claude CLI through configured GLM endpoint.');
  }

  // Launch Claude CLI
  const claude = spawn(claudeBinary, claudeArgs, {
    stdio: 'inherit',
    shell: false, // Don't use shell to avoid parsing issues with multi-line content
    env: claudeEnv,
  });

  claude.on('error', (error) => {
    console.error('Error launching Claude CLI:', error.message);
    console.error(
      '\nClaude CLI is required. See https://claude.ai/code for installation instructions.'
    );
    process.exit(1);
  });

  claude.on('exit', (code) => {
    process.exit(code || 0);
  });
}

main().catch((error) => {
  console.error('Unexpected error while starting Claude chat:', error);
  process.exit(1);
});
